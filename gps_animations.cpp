#include "gps_animations.h"

#include <Adafruit_SSD1306.h>
#include <TinyGPS++.h>

extern Adafruit_SSD1306 display;
extern TinyGPSPlus gps;

// animation bitmap
const uint8_t cat_idle[] PROGMEM = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x07, 0x07, 0xc0, 0x1e,
    0x0c, 0x60, 0x30, 0x08, 0x20, 0x20, 0x10, 0x00, 0x40, 0x10, 0x00, 0x40,
    0x23, 0x0c, 0x80, 0x23, 0x0c, 0x80, 0x20, 0x00, 0x80, 0x20, 0x40, 0x80,
    0x20, 0x40, 0x80, 0x10, 0x30, 0x40, 0x10, 0x00, 0x40, 0x08, 0x00, 0x20,
    0x0c, 0x00, 0x30, 0x07, 0x81, 0xe0, 0x04, 0x42, 0x20, 0x04, 0x42, 0x20,
    0x04, 0x42, 0x20, 0x07, 0xc3, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

const uint8_t cat_eat[] PROGMEM = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x18, 0x03, 0xc0, 0x3c,
    0x06, 0x60, 0x66, 0x04, 0x20, 0x42, 0x08, 0x00, 0x82, 0x08, 0x00, 0x82,
    0x11, 0x02, 0x22, 0x0a, 0x85, 0x44, 0x04, 0x41, 0x08, 0x00, 0x00, 0x00,
    0x00, 0x40, 0x00, 0x08, 0x20, 0x20, 0x0c, 0x00, 0x30, 0x07, 0x81, 0xe0,
    0x04, 0x42, 0x20, 0x04, 0x42, 0x20, 0x04, 0xff, 0xa0, 0x07, 0xff, 0xe0,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

const uint8_t cat_sleep[] PROGMEM = {
    0x00, 0x00, 0x00, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x20, 0x00, 0x00, 0x40,
    0x00, 0x03, 0x80, 0x00, 0x0f, 0xc0, 0x00, 0x30, 0x60, 0x00, 0x40, 0x20,
    0x00, 0x80, 0x10, 0x01, 0x00, 0x08, 0x01, 0x30, 0x08, 0x01, 0x30, 0x08,
    0x00, 0x00, 0x08, 0x00, 0x00, 0x10, 0x00, 0x00, 0x20, 0x0c, 0x00, 0x40,
    0x12, 0x00, 0x80, 0x11, 0x01, 0x00, 0x10, 0xfe, 0x00, 0x08, 0x02, 0x00,
    0x07, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

// animation functions
unsigned long tailTimer = 0;
bool tailLeft = false;

void drawCatSprite(int x, int y, const uint8_t* sprite, int sats) {
  display.drawBitmap(x, y, sprite, 24, 24, SSD1306_WHITE);

  // Tail wag speed scales with satellites
  int wagDelay = max(80, 400 - sats * 40);

  if (millis() - tailTimer > wagDelay) {
    tailTimer = millis();
    tailLeft = !tailLeft;
  }

  if (tailLeft)
    display.drawLine(x - 4, y + 10, x, y + 12, SSD1306_WHITE);
  else
    display.drawLine(x + 16, y + 10, x + 20, y + 12, SSD1306_WHITE);
}

void drawSignalBars(int sats) {
  int bars = constrain(sats / 2, 0, 5);

  for (int i = 0; i < 5; i++) {
    int h = (i + 1) * 4;
    if (i < bars)
      display.fillRect(4 + i * 6, 60 - h, 4, h, SSD1306_WHITE);
    else
      display.drawRect(4 + i * 6, 60 - h, 4, h, SSD1306_WHITE);
  }
}

void drawSleepingCat() {
  display.clearDisplay();
  display.setCursor(32, 0);
  display.println("Zzz...");
  drawCatSprite(56, 28, cat_sleep, 0);

  display.setCursor(50, 50);
  display.print("Z ");
  display.display();
}

void drawSearching() {
  int sats = gps.satellites.isValid() ? gps.satellites.value() : 0;

  display.clearDisplay();
  display.setCursor(0, 0);
  display.println("Searching GPS");
  display.print("Sats: ");
  display.println(sats);

  drawSignalBars(sats);

  if (sats == 0) {
    drawCatSprite(56, 28, cat_idle, sats);
  } else if (sats < 6) {
    drawCatSprite(56, 28, cat_eat, sats);
  } else {
    drawCatSprite(56, 28, cat_idle, sats);
    display.setCursor(30, 50);
    display.println("Almost!");
  }

  display.display();
}

void drawCelebration() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setCursor(10, 0);
  display.println("LOCK!");

  for (int i = 0; i < 12; i++)
    display.drawPixel(random(0, 128), random(16, 64), SSD1306_WHITE);

  drawCatSprite(56, 28 - ((millis() / 150) % 2) * 2, cat_idle, 8);
  display.display();
}
